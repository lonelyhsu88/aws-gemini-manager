# Arcade Games è¨˜æ†¶é«”ä½¿ç”¨å°æ¯”åˆ†æ

**ç”Ÿæˆæ™‚é–“**: 2025-11-16
**åˆ†æç›®çš„**: æ¯”è¼ƒæ‰€æœ‰ Arcade éŠæˆ²æœå‹™çš„è¨˜æ†¶é«”ä½¿ç”¨æ¨¡å¼

---

## ğŸ“Š å®Œæ•´å°æ¯”æ•¸æ“š

| æœå‹™ | DebugMode | è¨˜æ†¶é«”ä½¿ç”¨ | ä½¿ç”¨ç‡ | æ—¥èªŒ/å¤© | SQLæ—¥èªŒ | éŠæˆ²é¡å‹ |
|------|-----------|-----------|--------|---------|---------|----------|
| **wilddiggr** | **1** âŒ | **965Mi** | **96.5%** âš ï¸ | **253MB** | âœ… Yes | Scratch Card |
| **forestteaparty** | 0 âœ… | **707Mi** | **70.7%** ğŸŸ¡ | **254MB** | âœ… Yes | Arcade |
| **goldenclover** | 0 âœ… | **312Mi** | **31.2%** âœ… | **188MB** | âœ… Yes | Scratch Card |
| crashgr | 0 âœ… | 42Mi | 4.2% âœ… | 37MB | âŒ No | Hash Game |
| limbogr | 0 âœ… | 45Mi | 4.5% âœ… | 31MB | âŒ No | Hash Game |
| minesgr | 0 âœ… | 107Mi | 10.7% âœ… | ? | ? | Hash Game |
| plinkogr | 0 âœ… | 104Mi | 10.4% âœ… | ? | ? | Hash Game |

**å…±åŒé…ç½®**: æ‰€æœ‰æœå‹™ Resource Limit = 1Gi, Request = 700Mi

---

## ğŸ” é—œéµç™¼ç¾

### ç™¼ç¾ 1: SQL æ—¥èªŒæ˜¯é«˜è¨˜æ†¶é«”çš„**å¿…è¦ä½†éå……åˆ†**æ¢ä»¶

**æœ‰ SQL æ—¥èªŒçš„æœå‹™**ï¼š
- wilddiggr: 965Miï¼ˆæœ€é«˜ï¼‰
- forestteaparty: 707Miï¼ˆç¬¬äºŒé«˜ï¼‰
- goldenclover: 312Miï¼ˆä¸­ç­‰ï¼‰

**ç„¡ SQL æ—¥èªŒçš„æœå‹™**ï¼š
- crashgr, limbogr: 42-45Miï¼ˆæ¥µä½ï¼‰
- minesgr, plinkogr: 104-107Miï¼ˆä½ï¼‰

**çµè«–**:
- âœ… SQL æ—¥èªŒç¢ºå¯¦å°è‡´æ›´é«˜çš„è¨˜æ†¶é«”ä½¿ç”¨
- âš ï¸ ä½† SQL æ—¥èªŒ**ä¸æ˜¯å”¯ä¸€å› ç´ **ï¼ˆgoldenclover vs wilddiggr å·®ç•° 653Miï¼‰

---

### ç™¼ç¾ 2: DebugMode çš„å½±éŸ¿æœ‰é™ä½†çœŸå¯¦å­˜åœ¨

**åŒæ¨£æœ‰ SQL æ—¥èªŒçš„æœå‹™å°æ¯”**ï¼š

| æœå‹™ | DebugMode | è¨˜æ†¶é«” | æ—¥èªŒé‡ |
|------|-----------|--------|--------|
| wilddiggr | **1** | **965Mi** | 253MB |
| forestteaparty | 0 | 707Mi | 254MB |
| goldenclover | 0 | 312Mi | 188MB |

**DebugMode="1" vs "0" å½±éŸ¿**ï¼š
- wilddiggr vs forestteaparty: **+258Mi (+36%)**
- æ—¥èªŒé‡å¹¾ä¹ç›¸åŒï¼ˆ253MB vs 254MBï¼‰

**çµè«–**:
- âœ… DebugMode="1" ç¢ºå¯¦å¢åŠ è¨˜æ†¶é«”ä½¿ç”¨
- âœ… å½±éŸ¿ç´„ **250-300Mi (25-35%)**
- âš ï¸ ä½†ä¸æ˜¯ä¸»è¦å•é¡Œï¼ˆforestteaparty ä»æœ‰ 707Miï¼‰

---

### ç™¼ç¾ 3: éŠæˆ²é¡å‹/è¤‡é›œåº¦å·®ç•°

**Scratch Card é¡éŠæˆ²**ï¼ˆæœ‰ SQL æ—¥èªŒï¼‰ï¼š
- wilddiggr: 965Mi
- goldenclover: 312Mi
- **å·®ç•°**: 653Miï¼ˆ208%ï¼‰

**å¯èƒ½åŸå› **ï¼š
1. **ç©å®¶æ´»èºåº¦ä¸åŒ**
   - wilddiggr å¯èƒ½æœ‰æ›´å¤šåŒæ™‚åœ¨ç·šç©å®¶
   - æ›´å¤šä¸¦ç™¼æ•¸æ“šåº«æ“ä½œ

2. **éŠæˆ²é‚è¼¯è¤‡é›œåº¦**
   - wilddiggr å¯èƒ½æœ‰æ›´è¤‡é›œçš„éŠæˆ²ç‹€æ…‹
   - æ›´å¤šå…§å­˜ä¸­çš„éŠæˆ²å°è±¡

3. **æ•¸æ“šåº«æ“ä½œé »ç‡**
   - é›–ç„¶æ—¥èªŒé‡ç›¸è¿‘ï¼Œä½†æ“ä½œé »ç‡å¯èƒ½ä¸åŒ
   - wilddiggr: 253MB/å¤©
   - goldenclover: 188MB/å¤©
   - å·®ç•°ä¸è¶³ä»¥è§£é‡‹ 653Mi è¨˜æ†¶é«”å·®ç•°

---

## ğŸ¯ æ ¹æœ¬åŸå› åˆ†æï¼ˆä¿®æ­£ç‰ˆï¼‰

### å¤šå› ç´ æ¨¡å‹

```
wilddiggr é«˜è¨˜æ†¶é«” (965Mi) =
  + SQL æ—¥èªŒåŸºç¤æ¶ˆè€— (ç´„ 300-400Mi)
  + DebugMode="1" é¡å¤–æ¶ˆè€— (ç´„ 250-300Mi)
  + éŠæˆ²ç‰¹å®šå› ç´  (ç´„ 200-300Mi)
    - ç©å®¶æ•¸é‡
    - éŠæˆ²ç‹€æ…‹è¤‡é›œåº¦
    - æ•¸æ“šçµæ§‹
```

### è­‰æ“šå¼·åº¦è©•ä¼°

| å› ç´  | è­‰æ“šå¼·åº¦ | é æœŸæ”¹å–„ | å¯¦æ–½é›£åº¦ |
|------|----------|----------|----------|
| **SQL æ—¥èªŒ** | âœ…âœ…âœ… | 400-600Mi (40-60%) | ğŸ”´ é«˜ï¼ˆéœ€æ”¹ä»£ç¢¼ï¼‰ |
| **DebugMode="1"** | âœ…âœ…âœ… | 250-300Mi (25-30%) | ğŸŸ¢ ä½ï¼ˆæ”¹é…ç½®ï¼‰ |
| **éŠæˆ²ç‰¹å®š** | âœ… | æœªçŸ¥ | ğŸ”´ é«˜ï¼ˆéœ€æ·±å…¥åˆ†æï¼‰ |

---

## ğŸ’¡ ä¿®æ­£å¾Œçš„å„ªåŒ–å»ºè­°

### éšæ®µ 1: å¿«é€Ÿå‹åˆ©ï¼ˆ1-2 å¤©ï¼‰

#### 1.1 é—œé–‰ wilddiggr çš„ DebugMode

**æ“ä½œ**:
```bash
# åœ¨ GitLab kustomize-prd å€‰åº«ä¸­
# ä¿®æ”¹: gemini-game/overlays/prd/arcade-svc/arcade-wilddiggr-game/
# DebugMode="1" â†’ DebugMode="0"
```

**é æœŸæ•ˆæœ**:
- è¨˜æ†¶é«”: 965Mi â†’ **650-700Mi** (é™ä½ 27-35%)
- é¢¨éšª: æ¥µä½
- æ™‚é–“: < 1 å°æ™‚

**é©—è­‰**:
```bash
# ä¿®æ”¹å¾Œ 30 åˆ†é˜
kubectl top pod wilddiggr-0 -n wilddiggr-prd
# é æœŸ: < 750Mi
```

#### 1.2 forestteaparty å·²æ˜¯æœ€ä½³é…ç½®

**ç™¼ç¾**: forestteaparty çš„ DebugMode å·²ç¶“æ˜¯ "0" âœ…

**çµè«–**:
- forestteaparty å·²æ¡ç”¨æ­£ç¢ºé…ç½®ï¼Œä½†ä»ä½¿ç”¨ 707Mi (70.7%)
- é€™è­‰æ˜å³ä½¿é—œé–‰ DebugModeï¼ŒSQL æ—¥èªŒä»ç„¶æœƒé€ æˆé«˜è¨˜æ†¶é«”ä½¿ç”¨
- forestteaparty çš„é«˜è¨˜æ†¶é«”ä¸»è¦ä¾†è‡ªï¼šSQL æ—¥èªŒ + éŠæˆ²ç‰¹å®šå› ç´ 

---

### éšæ®µ 2: ä¸­æœŸå„ªåŒ–ï¼ˆ1-2 é€±ï¼‰

#### 2.1 è©•ä¼° SQL æ—¥èªŒçš„å¿…è¦æ€§

**å•é¡Œ**: ç‚ºä»€éº¼ wilddiggr, forestteaparty, goldenclover éœ€è¦ SQL æ—¥èªŒï¼Ÿ

**èª¿æŸ¥é‡é»**:
1. æª¢æŸ¥æºä»£ç¢¼ä¸­ `common/custom_logger.go` çš„é…ç½®
2. æ˜¯å¦æœ‰ç’°å¢ƒè®Šæ•¸å¯ä»¥æ§åˆ¶ï¼Ÿ
3. é€™æ˜¯é–‹ç™¼æ™‚ç•™ä¸‹çš„ debug é…ç½®ï¼Ÿ

**å¯èƒ½çš„é…ç½®ä½ç½®**:
```go
// æ¨æ¸¬åœ¨ä»£ç¢¼ä¸­
db, err := gorm.Open(postgres.Open(dsn), &gorm.Config{
    Logger: customLogger,  // â† é€™è£¡
})
```

**é¸é …**:
1. æ‰¾åˆ°ç’°å¢ƒè®Šæ•¸æ§åˆ¶ï¼ˆæœ€å¿«ï¼‰
2. ä¿®æ”¹ä»£ç¢¼ï¼Œæ·»åŠ ç’°å¢ƒè®Šæ•¸é–‹é—œ
3. æ¢ä»¶ç·¨è­¯ï¼Œç”Ÿç”¢ç’°å¢ƒç¦ç”¨

#### 2.2 ç¦ç”¨ SQL æ—¥èªŒï¼ˆå¦‚æœå¯è¡Œï¼‰

**é æœŸæ•ˆæœ**ï¼ˆåŸºæ–¼ goldenclover vs crashgr å°æ¯”ï¼‰:
- wilddiggr: 650Mi â†’ **150-200Mi** (é¡å¤–é™ä½ 70%)
- forestteaparty: 450Mi â†’ **100-150Mi** (é¡å¤–é™ä½ 70%)
- goldenclover: 312Mi â†’ **100Mi** (é™ä½ 68%)

**ç¸½æ”¹å–„** (wilddiggr):
- 965Mi â†’ 150-200Mi (**é™ä½ 80-85%**)

---

### éšæ®µ 3: æ·±å…¥åˆ†æï¼ˆéœ€è¦æ™‚ï¼‰

#### 3.1 å¦‚æœéšæ®µ 1+2 å¾Œ wilddiggr ä» > 300Mi

**éœ€è¦èª¿æŸ¥**:
1. **ç©å®¶æ•¸æ“š**:
   ```bash
   # æª¢æŸ¥ç•¶å‰åœ¨ç·šç©å®¶æ•¸
   kubectl exec -n wilddiggr-prd wilddiggr-0 -- curl -s http://localhost:9002/api/stats
   ```

2. **pprof heap è©³ç´°åˆ†æ**:
   ```bash
   # åœ¨ç¦ç”¨æ—¥èªŒå¾Œé‡æ–°åˆ†æ
   kubectl port-forward -n wilddiggr-prd wilddiggr-0 6605:6605
   go tool pprof http://localhost:6605/debug/pprof/heap
   ```

3. **å°æ¯” goldenclover**:
   - ç‚ºä»€éº¼ goldenclover åªéœ€è¦ 312Miï¼Ÿ
   - æ¥­å‹™é‚è¼¯æœ‰ä½•ä¸åŒï¼Ÿ
   - æ•¸æ“šçµæ§‹å·®ç•°ï¼Ÿ

---

## ğŸ“‹ åŸ·è¡Œè¨ˆåŠƒ

### ç«‹å³åŸ·è¡Œï¼ˆP0ï¼‰

- [ ] **ä¿®æ”¹ wilddiggr DebugMode="0"**
  - Repository: kustomize-prd.git
  - Path: gemini-game/overlays/prd/arcade-svc/arcade-wilddiggr-game
  - ç•¶å‰: DebugMode="1", 965Mi (96.5%) âŒ
  - é æœŸ: 965Mi â†’ 650-700Mi (é™ä½ 27-35%)

### 1-2 é€±å…§ï¼ˆP1ï¼‰

- [ ] **èª¿æŸ¥ SQL æ—¥èªŒé…ç½®**
  - æª¢æŸ¥æºä»£ç¢¼
  - å°‹æ‰¾ç’°å¢ƒè®Šæ•¸é¸é …
  - è©•ä¼°ç¦ç”¨çš„å½±éŸ¿

- [ ] **ç¦ç”¨ SQL æ—¥èªŒï¼ˆå¦‚æœå¯è¡Œï¼‰**
  - wilddiggr, forestteaparty, goldenclover
  - é æœŸç¸½æ”¹å–„ï¼š80-85%

### æŒçºŒç›£æ§ï¼ˆP2ï¼‰

- [ ] **è¨­ç½® Grafana å‘Šè­¦**
  - Memory > 80%: Warning
  - Memory > 90%: Critical

- [ ] **å®šæœŸæª¢æŸ¥**ï¼ˆæ¯é€±ï¼‰
  - è¨˜æ†¶é«”è¶¨å‹¢
  - æ—¥èªŒå¢é•·
  - OOM äº‹ä»¶

---

## ğŸ§ª A/B å°æ¯”ï¼ˆç”¨æ–¼é©—è­‰å‡è¨­ï¼‰

### å¯¦é©—è¨­è¨ˆ

| æœå‹™ | ç•¶å‰ç‹€æ…‹ | ä¿®æ”¹å¾Œ | é æœŸçµæœ |
|------|----------|--------|----------|
| wilddiggr | DebugMode=1, SQL=Yes, 965Mi | DebugMode=0, SQL=Yes | 650-700Mi |
| wilddiggr | DebugMode=0, SQL=Yes | DebugMode=0, SQL=No | 150-200Mi |
| forestteaparty | DebugMode=0, SQL=Yes, 707Mi | DebugMode=0, SQL=No | 200-300Mi |

### é©—è­‰æŒ‡æ¨™

1. **è¨˜æ†¶é«”ä½¿ç”¨**:
   ```bash
   kubectl top pod {pod-name} -n {namespace}
   ```

2. **æ—¥èªŒé‡**:
   ```bash
   kubectl exec -n {namespace} {pod} -- du -sh /app/log/
   ```

3. **æ‡‰ç”¨æ€§èƒ½**:
   - éŸ¿æ‡‰æ™‚é–“ç„¡æƒ¡åŒ–
   - éŒ¯èª¤ç‡ç„¡å¢åŠ 

---

## ğŸ“Š ç¸½çµå°æ¯”è¡¨

### ç•¶å‰ç‹€æ…‹ vs å„ªåŒ–å¾Œï¼ˆé ä¼°ï¼‰

| æœå‹™ | ç•¶å‰ | éšæ®µ1å¾Œ | éšæ®µ2å¾Œ | ç¸½æ”¹å–„ | å‚™è¨» |
|------|------|---------|---------|--------|------|
| **wilddiggr** | **965Mi** | **700Mi** | **200Mi** | **79%** âœ… | DebugMode=1 éœ€ä¿®æ”¹ |
| **forestteaparty** | **707Mi** | **707Mi** | **250Mi** | **65%** âœ… | DebugMode=0 å·²æ­£ç¢º |
| **goldenclover** | 312Mi | 312Mi | 100Mi | 68% âœ… | DebugMode=0 å·²æ­£ç¢º |
| crashgr | 42Mi | 42Mi | 42Mi | - | åƒè€ƒåŸºæº– |
| limbogr | 45Mi | 45Mi | 45Mi | - | åƒè€ƒåŸºæº– |

---

## ğŸ¯ é—œéµæ´å¯Ÿ

### 1. SQL æ—¥èªŒ â‰  å¿…ç„¶é«˜è¨˜æ†¶é«”

goldenclover è­‰æ˜ï¼šå³ä½¿æœ‰ SQL æ—¥èªŒï¼Œè¨˜æ†¶é«”ä»å¯æ§åˆ¶åœ¨ 312Mi

### 2. DebugMode å½±éŸ¿çœŸå¯¦ä½†æœ‰é™

wilddiggr vs forestteaparty å·®ç•° (~250Mi) è­‰æ˜ DebugMode çš„å½±éŸ¿

### 3. å¤šå› ç´ ç¶œåˆä½œç”¨

wilddiggr é«˜è¨˜æ†¶é«” = SQLæ—¥èªŒ + DebugMode + éŠæˆ²ç‰¹å®šå› ç´ 

### 4. æœ€ä½³å¯¦è¸

**ç”Ÿç”¢ç’°å¢ƒæ¨™æº–é…ç½®**:
- âœ… DebugMode="0"
- âœ… SQL æ—¥èªŒç¦ç”¨æˆ–åƒ…æ…¢æŸ¥è©¢
- âœ… æ—¥èªŒç´šåˆ¥ = Warn/Error
- âœ… è¨˜æ†¶é«”ä½¿ç”¨ < 30% of limit

---

## âš ï¸ é‡è¦æ›´æ­£ï¼ˆ2025-11-16ï¼‰

### åŸå§‹éŒ¯èª¤

åˆç‰ˆåˆ†æä¸­éŒ¯èª¤åœ°è²ç¨± forestteaparty çš„ DebugMode="1"ï¼Œä½†å¯¦éš›é©—è­‰é¡¯ç¤ºï¼š

```bash
kubectl exec -n forestteaparty-prd forestteaparty-0 -- cat /app/setting.xml | grep DebugMode
# å¯¦éš›çµæœ: DebugMode="0" âœ…
```

### ä¿®æ­£å¾Œçš„çµè«–

**DebugMode å½±éŸ¿åˆ†æ**ï¼š
- wilddiggr (DebugMode=1): 965Mi
- forestteaparty (DebugMode=0): 707Mi
- **DebugMode="1" å¢åŠ ç´„ 250-300Mi (27-35%)**

**SQL æ—¥èªŒå½±éŸ¿åˆ†æ**ï¼š
- forestteaparty (DebugMode=0, SQL=Yes): 707Mi
- goldenclover (DebugMode=0, SQL=Yes): 312Mi
- crashgr (DebugMode=0, SQL=No): 42Mi
- **SQL æ—¥èªŒæ˜¯å¿…è¦ä½†éå……åˆ†æ¢ä»¶**

**å¤šå› ç´ æ¨¡å‹ï¼ˆä¿®æ­£ç‰ˆï¼‰**ï¼š
```
wilddiggr (965Mi) = åŸºç¤ + DebugMode(+258Mi) + SQLæ—¥èªŒ + éŠæˆ²ç‰¹å®š
forestteaparty (707Mi) = åŸºç¤ + SQLæ—¥èªŒ + éŠæˆ²ç‰¹å®šï¼ˆDebugMode å·²å„ªåŒ–ï¼‰
goldenclover (312Mi) = åŸºç¤ + SQLæ—¥èªŒï¼ˆè¼ƒä½æµé‡ï¼‰
```

### ç«‹å³è¡Œå‹•é …ç›®

**åƒ…éœ€ä¿®æ”¹ wilddiggr**ï¼š
- âœ… wilddiggr: DebugMode="1" â†’ "0" ï¼ˆé æœŸé™ä½ 250-300Miï¼‰
- âœ… forestteaparty: å·²æ­£ç¢ºé…ç½®ï¼Œç„¡éœ€ä¿®æ”¹
- âœ… goldenclover: å·²æ­£ç¢ºé…ç½®ï¼Œç„¡éœ€ä¿®æ”¹

---

**ä¸‹ä¸€æ­¥**: ç«‹å³åŸ·è¡Œ wilddiggr DebugMode ä¿®æ”¹ï¼ˆé æœŸæ”¹å–„ 27-35%ï¼‰
