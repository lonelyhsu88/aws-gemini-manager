# 三地區遊戲緩存綜合測試指南

## 📋 概覽

這是一套完整的三地區（東京、孟買、新加坡）網站性能測試工具，整合了：

1. **遊戲緩存對比測試** - 測量首次訪問 vs 第二次訪問的性能差異
2. **API 延遲測試** - 測試主要 API 的響應時間
3. **MTR 網路路徑追蹤** - 分析網路路由和延遲

## 🎯 測試特點

### ✅ 優化設計
- **並行執行**: 三個地區同時測試，總時間 ~17 分鐘（而非 50+ 分鐘）
- **本地獲取 URL**: 在本地一次性獲取遊戲 URL，避免在每個 EC2 重複調用 API
- **自動化部署**: 自動創建 EC2、安裝依賴、執行測試、收集結果

### 📊 測試內容
- **遊戲加載速度**: 使用 Puppeteer 模擬真實瀏覽器，測量完整加載時間
- **緩存效果**: 對比首次訪問和第二次訪問，計算緩存命中率和改善百分比
- **API 延遲**: 測試 3 個主要 API，每個測試 5 次取平均值
- **網路路徑**: 使用 MTR 追蹤到 CDN 的完整路徑

## 🚀 快速開始

### 前置需求

1. **AWS CLI** 配置完成（profile: `gemini-pro_ck`）
2. **必要工具**: bash, curl, aws-cli
3. **SSH 密鑰目錄**: `~/.ssh/` 可寫
4. **網路**: 能連接到 AWS 和測試 API

### 基本用法

```bash
cd /Users/lonelyhsu/gemini/claude-project/aws-gemini-manager/scripts/ec2

# 測試 5 個遊戲（默認）
./test-3regions-game-cache-comprehensive.sh

# 測試 10 個遊戲，等待時間 20 秒
./test-3regions-game-cache-comprehensive.sh 10 20000
```

### 參數說明

```bash
./test-3regions-game-cache-comprehensive.sh [遊戲數量] [等待時間ms]

參數:
  遊戲數量  - 要測試的遊戲數量（默認: 5）
  等待時間  - 頁面加載等待時間，毫秒（默認: 15000）

範例:
  ./test-3regions-game-cache-comprehensive.sh 3 10000   # 3個遊戲，等待10秒
  ./test-3regions-game-cache-comprehensive.sh 8 20000   # 8個遊戲，等待20秒
```

## 📁 腳本結構

### 主腳本
- **test-3regions-game-cache-comprehensive.sh** - 主測試腳本（在本地執行）
  - 本地獲取遊戲 URLs
  - 並行部署三個 EC2 實例
  - 執行測試並收集結果
  - 生成綜合報告

### 遠端腳本（上傳到 EC2）
- **remote-game-url-test.sh** - 遊戲緩存測試（在 EC2 上執行）
  - 接受 URL 列表文件
  - 執行 Puppeteer 雙重訪問測試
  - 生成測試報告和 CSV

- **remote-api-mtr-test.sh** - API/MTR 測試（在 EC2 上執行）
  - API 延遲測試（3個 API，各5次）
  - MTR 網路路徑追蹤（4個目標）
  - 網路診斷（DNS、連接性、地理位置）

### 依賴腳本
- **puppeteer_game_test.js** - Puppeteer 測試核心
  - 位置: `/Users/lonelyhsu/gemini/toolkits/game_login/game-test/puppeteer_game_test.js`
  - 自動上傳到 EC2

## 🔄 執行流程

```
┌─────────────────────────────────────────────────────────────┐
│ 步驟 1: 本地獲取遊戲 URLs                                    │
│  • 隨機選擇 N 個遊戲                                         │
│  • 調用 API 獲取遊戲 URLs                                    │
│  • 保存到 game-urls-TIMESTAMP.txt                            │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ 步驟 2: 準備測試腳本和 SSH 密鑰                              │
│  • 檢查必要腳本是否存在                                      │
│  • 為每個區域創建/確認 SSH 密鑰對                            │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ 步驟 3: 並行部署和測試（三個地區同時）                       │
│                                                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │   東京 🇯🇵    │  │   孟買 🇮🇳    │  │  新加坡 🇸🇬   │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│         │                 │                 │               │
│         ├─ 啟動 EC2      ├─ 啟動 EC2      ├─ 啟動 EC2      │
│         ├─ 安裝依賴      ├─ 安裝依賴      ├─ 安裝依賴      │
│         ├─ 上傳腳本      ├─ 上傳腳本      ├─ 上傳腳本      │
│         ├─ 遊戲測試      ├─ 遊戲測試      ├─ 遊戲測試      │
│         ├─ API 測試      ├─ API 測試      ├─ API 測試      │
│         ├─ MTR 測試      ├─ MTR 測試      ├─ MTR 測試      │
│         └─ 下載結果      └─ 下載結果      └─ 下載結果      │
│                                                              │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ 步驟 4: 生成綜合報告                                         │
│  • 整合三個地區的結果                                        │
│  • 生成 Markdown 報告                                        │
│  • 顯示結果摘要                                              │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ 步驟 5: 清理資源（可選）                                     │
│  • 提示是否終止 EC2 實例                                     │
│  • 保留測試結果                                              │
└─────────────────────────────────────────────────────────────┘
```

## 📊 輸出結果

### 結果目錄結構

```
scripts/ec2/
├── game-urls-20251031_153000.txt          # 遊戲 URL 列表
├── comprehensive-report-20251031_154500.md # 綜合報告
│
├── tokyo-results-20251031_154500/          # 東京測試結果
│   ├── game-test.log                       # 遊戲測試日誌
│   ├── api-mtr-test.log                    # API/MTR 測試日誌
│   ├── game-cache-test-TIMESTAMP/          # 遊戲詳細結果
│   │   ├── ArcadeBingo.json
│   │   ├── MultiPlayerAviator.json
│   │   ├── summary.csv
│   │   └── summary.txt
│   └── api-mtr-test-TIMESTAMP/             # API/MTR 詳細結果
│       ├── SUMMARY.txt
│       ├── api-latency.txt
│       ├── mtr-traceroute.txt
│       └── network-diagnostics.txt
│
├── mumbai-results-20251031_154500/         # 孟買測試結果
│   └── (同上結構)
│
└── singapore-results-20251031_154500/      # 新加坡測試結果
    └── (同上結構)
```

### 遊戲測試結果示例

```
═══════════════════════════════════════════════════════════════════════
                       遊戲緩存測試結果摘要
═══════════════════════════════════════════════════════════════════════

遊戲名稱                          首次(s)    第2次(s)      改善%     緩存率%
──────────────────────────────────────────────────────────────────────
ArcadeBingo                        12.45       8.23      33.9       72.5
MultiPlayerAviator                 15.67      10.12      35.4       68.9
StandAlonePlinko                   11.89       7.56      36.4       75.2
──────────────────────────────────────────────────────────────────────
平均                               13.34       8.64      35.2       72.2

╔════════════════════════════════════════════════════════════════════╗
║                          關鍵指標                                   ║
╚════════════════════════════════════════════════════════════════════╝

  測試遊戲數量:     3
  平均改善幅度:     35.2%
  平均緩存命中率:   72.2%
  平均首次加載:     13.34 秒
  平均第2次加載:    8.64 秒
  平均節省時間:     4.70 秒

  ✅ 緩存效能: 優秀 (>70% 命中率)
```

### API 延遲測試結果示例

```
=== API 延遲測試結果 ===
測試時間: Fri Oct 31 15:45:00 UTC 2025

測試 API 1: https://ds-r.geminiservice.cc/domains?type=Hash
----------------------------------------
  請求 1: 0.145s
  請求 2: 0.142s
  請求 3: 0.148s
  請求 4: 0.143s
  請求 5: 0.147s
  平均延遲: 0.145s

測試 API 2: https://gameinfo-api.geminiservice.cc/api/v1/operator/url/gameInfo?productId=ELS&gameType=StandAlonePlinko
----------------------------------------
  請求 1: 0.151s
  請求 2: 0.149s
  請求 3: 0.153s
  請求 4: 0.148s
  請求 5: 0.152s
  平均延遲: 0.151s
```

## ⏱️ 預期執行時間

| 階段 | 時間 | 說明 |
|------|------|------|
| 獲取 URLs | 1-2 分鐘 | 根據遊戲數量 |
| EC2 啟動和安裝 | 3-5 分鐘 | 並行執行 |
| 遊戲測試 | 8-12 分鐘 | 根據遊戲數量和等待時間 |
| API/MTR 測試 | 2-3 分鐘 | 並行執行 |
| 結果收集 | 1-2 分鐘 | - |
| **總計** | **15-20 分鐘** | 三個地區並行 |

## 💰 成本估算

### AWS EC2 費用

| 地區 | 實例類型 | 小時費率 | 測試時長 | 預估費用 |
|------|---------|---------|---------|---------|
| 東京 | t3.medium | ~$0.052/hr | 0.5 hr | $0.026 |
| 孟買 | t3.medium | ~$0.048/hr | 0.5 hr | $0.024 |
| 新加坡 | t3.medium | ~$0.050/hr | 0.5 hr | $0.025 |
| **總計** | - | - | - | **~$0.075** |

**注意**:
- 費用僅為估算，實際費用可能因地區和時間而異
- 記得測試完成後終止實例！

## 🔧 常見問題

### Q1: 測試失敗怎麼辦？

**A**: 檢查以下幾點：

1. **AWS 配置**
   ```bash
   aws --profile gemini-pro_ck sts get-caller-identity
   ```

2. **網路連接**
   ```bash
   curl -I https://wallet-api.geminiservice.cc
   ```

3. **查看錯誤日誌**
   - 檢查各地區的 `game-test.log` 和 `api-mtr-test.log`
   - EC2 上的日誌: `/var/log/user-data.log`

### Q2: 如何只測試特定地區？

**A**: 修改主腳本中的並行執行部分，註釋掉不需要的地區：

```bash
# 只測試東京
deploy_and_test "tokyo" "ap-northeast-1" "ami-0d52744d6551d851e" "東京" > "$TOKYO_RESULT_FILE" 2>&1 &
TOKYO_PID=$!

# 註釋掉孟買和新加坡
# deploy_and_test "mumbai" "ap-south-1" "ami-0c2af51e265bd5e0e" "孟買" > "$MUMBAI_RESULT_FILE" 2>&1 &
# MUMBAI_PID=$!
```

### Q3: 如何測試自定義 URL 列表？

**A**: 創建自己的 URL 列表文件：

```bash
# 創建 my-urls.txt
cat > my-urls.txt << EOF
Game1|https://example.com/game1
Game2|https://example.com/game2
Game3|https://example.com/game3
EOF

# 跳過步驟 1，直接使用自定義 URL
# 修改主腳本或手動執行遠端測試
```

### Q4: Puppeteer 測試超時怎麼辦？

**A**: 增加等待時間：

```bash
# 將等待時間從 15 秒增加到 30 秒
./test-3regions-game-cache-comprehensive.sh 5 30000
```

### Q5: 如何保留 EC2 實例進行調試？

**A**: 在清理階段選擇 "n"，然後手動連接：

```bash
# 獲取實例 IP（從測試輸出中）
ssh -i ~/.ssh/3region-test-key-ap-northeast-1.pem ubuntu@<PUBLIC_IP>

# 查看日誌
tail -f /var/log/user-data.log
cd ~
ls -la
```

## 📈 進階用法

### 自定義遊戲列表

編輯主腳本中的 `ALL_GAMES` 陣列：

```bash
ALL_GAMES=(
    "YourGame1"
    "YourGame2"
    "YourGame3"
)
```

### 自定義 API 端點

編輯 `remote-api-mtr-test.sh` 中的 API 列表：

```bash
API1="https://your-api-1.example.com"
API2="https://your-api-2.example.com"
```

### 調整 EC2 實例類型

修改主腳本中的 `INSTANCE_TYPE`：

```bash
INSTANCE_TYPE="t3.large"  # 更大的實例
INSTANCE_TYPE="t3.small"  # 更小的實例（可能無法運行 Puppeteer）
```

## 🎯 最佳實踐

1. **首次運行**: 先用 1-2 個遊戲測試，確保流程順暢
2. **網路穩定**: 確保本機網路穩定，測試期間保持連接
3. **結果備份**: 測試結果自動保存在本地，建議定期備份
4. **成本控制**: 測試完成後立即終止 EC2 實例
5. **時間選擇**: 避開業務高峰期測試，結果更準確

## 📞 支援

如有問題，請檢查：

1. **日誌文件**: 查看各測試階段的日誌
2. **AWS Console**: 檢查 EC2 實例狀態
3. **網路連接**: 確保能訪問測試 API

## 🔄 更新記錄

- **2025-10-31**: 初始版本
  - 支持三地區並行測試
  - 整合遊戲緩存、API 延遲、MTR 追蹤
  - 本地獲取 URL，避免重複 API 調用

---

**Happy Testing! 🚀**
