#!/usr/bin/env bash
# GuardDuty Malware Scan Status Checker
# Created: 2026-01-20

set -euo pipefail

PROFILE="${AWS_PROFILE:-gemini-pro_ck}"
DETECTOR_ID="a6cdeca75153840d6d513f23996ba1cf"

echo "=========================================="
echo "GuardDuty Malware æƒæç‹€æ…‹"
echo "=========================================="
echo "Detector ID: $DETECTOR_ID"
echo "æª¢æŸ¥æ™‚é–“: $(date '+%Y-%m-%d %H:%M:%S')"
echo ""

# çµ±è¨ˆæ‘˜è¦
echo "ğŸ“Š æƒæçµ±è¨ˆï¼š"
aws --profile "$PROFILE" guardduty describe-malware-scans \
  --detector-id "$DETECTOR_ID" \
  --max-results 50 \
  --output json | jq -r '
    .Scans | group_by(.ScanStatus) |
    map({status: .[0].ScanStatus, count: length}) |
    .[] | "   \(.status): \(.count) å€‹"
  '

echo ""
echo "----------------------------------------"
echo "ğŸ“‹ è©³ç´°æƒæçµæœï¼š"
echo ""

aws --profile "$PROFILE" guardduty describe-malware-scans \
  --detector-id "$DETECTOR_ID" \
  --max-results 50 \
  --output json | jq -r '
    .Scans[] |
    "[\(.ScanStatus)] \(.ScanId[0:12])... | \(.TotalBytes // 0 | . / 1024 / 1024 | floor)MB scanned | Files: \(.FileCount // 0) | Threats: \(.ThreatDetectedCount // 0)"
  '

echo ""
echo "----------------------------------------"
echo "ğŸ” æª¢æŸ¥ GuardDuty Findings (å¦‚æœ‰å¨è„…)ï¼š"

FINDINGS=$(aws --profile "$PROFILE" guardduty list-findings \
  --detector-id "$DETECTOR_ID" \
  --finding-criteria '{"Criterion":{"type":{"Eq":["Trojan","Backdoor","CryptoCurrency","Malware"]}}}' \
  --output json | jq -r '.FindingIds | length')

if [ "$FINDINGS" -gt 0 ]; then
  echo "âš ï¸  ç™¼ç¾ $FINDINGS å€‹æ½›åœ¨å¨è„…ï¼"
  echo ""
  aws --profile "$PROFILE" guardduty get-findings \
    --detector-id "$DETECTOR_ID" \
    --finding-ids $(aws --profile "$PROFILE" guardduty list-findings \
      --detector-id "$DETECTOR_ID" \
      --max-results 10 \
      --output json | jq -r '.FindingIds | join(" ")') \
    --output json | jq -r '
      .Findings[] |
      "[\(.Severity)] \(.Type)\n   Resource: \(.Resource.InstanceDetails.InstanceId // "N/A")\n   Description: \(.Description[0:100])...\n"
    '
else
  echo "âœ… ç›®å‰æ²’æœ‰ç™¼ç¾å¨è„…"
fi

echo ""
echo "=========================================="
