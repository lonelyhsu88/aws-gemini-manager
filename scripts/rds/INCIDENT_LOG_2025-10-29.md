# 測試事件記錄 - 2025-10-29

**事件類型**: 測試消息誤發送到生產環境
**嚴重程度**: 低（無實際影響，僅造成困擾）
**狀態**: ✅ 已解決

---

## 📋 事件摘要

**發生時間**: 2025-10-29 16:35:45 (UTC+8)
**發現時間**: 2025-10-29 17:33:00 (UTC+8)
**解決時間**: 2025-10-29 17:35:00 (UTC+8)
**持續時間**: ~57 分鐘（發生到發現）

**事件描述**:
在優化 CloudWatch Slack 通知 Lambda 函數期間，測試消息被發送到生產 Slack 頻道 (#aws-cloudwatch)，造成用戶收到虛假的 RDS 連線數告警。

---

## 🔍 時間線

| 時間 (UTC+8) | 事件 |
|-------------|------|
| 16:56 | Lambda 函數優化開始 |
| 17:03 | Lambda 函數代碼更新完成 |
| 17:05 | 執行第一次測試調用 |
| 17:06 | 修復代碼錯誤（dimension key 大小寫問題） |
| 17:06 | 執行第二次測試調用 - **測試消息發送到生產頻道** |
| 17:07 | Lambda 測試成功，未意識到已發送到生產頻道 |
| 17:19 | 執行 24 小時連線數分析（未注意到測試消息） |
| 17:33 | **用戶報告收到告警** |
| 17:33 | 立即查詢實際連線數，確認為測試消息 |
| 17:35 | 向用戶解釋並道歉 |
| 17:40 | 開始撰寫測試最佳實踐文檔 |

---

## 📊 詳細資訊

### 測試消息內容

```json
{
  "Records": [{
    "Sns": {
      "Message": {
        "AlarmName": "[P1] bingo-prd-RDS-Connections-High",
        "NewStateValue": "ALARM",
        "NewStateReason": "Threshold Crossed: 2 datapoints [690.0 (29/10/25 08:35:00), 682.0 (29/10/25 08:30:00)] were greater than the threshold (675.0).",
        "StateChangeTime": "2025-10-29T08:35:45.456+0000",
        "OldStateValue": "OK",
        "Trigger": {
          "MetricName": "DatabaseConnections",
          "Threshold": 675.0,
          "Dimensions": [{"value": "bingo-prd"}]
        }
      }
    }
  }]
}
```

**特徵**:
- 連線數: 690.0, 682.0 (虛構數據)
- 實例: bingo-prd
- 時間: 2025-10-29 08:35:45 (UTC)

### 實際情況對比

| 項目 | 測試消息 | 實際情況 |
|------|---------|---------|
| 連線數 | 690, 682 | 140-145 |
| 告警狀態 | ALARM | OK |
| 是否真實 | ❌ 測試數據 | ✅ 正常運行 |
| 超過閾值 | 是（虛構） | 否 |

---

## 🎯 根本原因分析

### 直接原因
Lambda 測試時使用了生產環境的 webhook URL，測試消息直接發送到生產 Slack 頻道。

### 根本原因（5 Whys）

1. **為什麼測試消息發送到生產頻道？**
   - 因為 Lambda 函數使用硬編碼的生產 webhook URL

2. **為什麼使用硬編碼的生產 URL？**
   - 因為沒有配置環境變量區分測試/生產環境

3. **為什麼沒有配置環境變量？**
   - 因為原始 Lambda 函數設計時沒有考慮測試需求

4. **為什麼測試時沒有注意到這個問題？**
   - 因為沒有測試前檢查清單和流程

5. **為什麼沒有測試流程？**
   - 因為沒有建立 Lambda 測試的最佳實踐文檔

---

## 📝 影響評估

### 業務影響
- ✅ **無業務中斷**: RDS 運行正常，未受影響
- ✅ **無數據損失**: 無任何數據受損
- ✅ **無服務降級**: 服務品質未受影響

### 運維影響
- ⚠️ **虛假告警**: 用戶收到 1 則虛假告警通知
- ⚠️ **信任度**: 可能短暫降低監控系統可信度
- ⚠️ **時間損失**: 約 10 分鐘用於確認和解釋

### 用戶影響
- 1 位用戶受影響（收到虛假通知）
- 造成約 5 分鐘的困惑
- 無實際操作需求

**影響等級**: 🟢 **低** (Severity: Low)

---

## ✅ 解決方案

### 即時行動（已完成）

1. ✅ **向用戶解釋**
   - 確認這是測試消息，非真實告警
   - 提供實際連線數數據（140-145）
   - 確認 CloudWatch 告警狀態為 OK

2. ✅ **驗證實際狀態**
   - 查詢最近 1 小時連線數: 140-153
   - 確認告警狀態: OK
   - 確認距離閾值: 535 connections

3. ✅ **道歉並記錄**
   - 向用戶道歉
   - 承諾建立測試流程

### 預防措施（已實施）

1. ✅ **創建測試最佳實踐文檔**
   - 文件: `TESTING_BEST_PRACTICES.md`
   - 內容: 完整的測試流程和規範
   - 包含: 檢查清單、工具、示例

2. ✅ **創建快速參考指南**
   - 文件: `TESTING_QUICK_REFERENCE.md`
   - 內容: 簡化的測試步驟
   - 用途: 快速查閱

3. ✅ **記錄事件詳情**
   - 文件: `INCIDENT_LOG_2025-10-29.md` (本文件)
   - 目的: 經驗傳承

---

## 🔄 後續行動項目

### 短期行動（1週內）

- [ ] **設置測試 Slack 頻道**
  - 頻道名稱: #aws-cloudwatch-test
  - 創建 webhook
  - 責任人: DevOps Team
  - 截止日期: 2025-11-05

- [ ] **配置 Lambda 環境變量**
  - 添加 ENVIRONMENT=production|test
  - 添加 SLACK_WEBHOOK_URL (使用 env var)
  - 責任人: DevOps Team
  - 截止日期: 2025-11-05

- [ ] **創建 Lambda 別名**
  - prod alias -> 生產版本
  - test alias -> 測試版本
  - 責任人: DevOps Team
  - 截止日期: 2025-11-05

### 中期行動（1個月內）

- [ ] **開發本地測試工具**
  - 腳本: test-lambda-locally.py
  - 功能: 測試格式不發送
  - 責任人: DevOps Team
  - 截止日期: 2025-11-29

- [ ] **建立測試自動化**
  - CI/CD 整合測試
  - 自動格式驗證
  - 責任人: DevOps Team
  - 截止日期: 2025-11-29

- [ ] **團隊培訓**
  - 分享此次事件
  - 講解測試流程
  - 責任人: Team Lead
  - 截止日期: 2025-11-29

### 長期改進

- [ ] **監控告警品質**
  - 追蹤虛假告警率
  - 定期審查閾值
  - 持續優化

- [ ] **完善監控體系**
  - 建立告警層級
  - 優化通知策略
  - 加強可觀測性

---

## 📚 學到的教訓

### 技術層面

1. **環境隔離至關重要**
   - 測試和生產必須明確分離
   - 使用環境變量或別名區分
   - 硬編碼配置是技術債

2. **測試需要完整流程**
   - 不能跳過測試步驟
   - 需要檢查清單確保完整
   - 自動化能減少人為錯誤

3. **標記和通知很重要**
   - 測試消息必須明確標記
   - 測試前必須通知團隊
   - 清晰溝通避免誤解

### 流程層面

1. **文檔先於行動**
   - 先建立流程再執行
   - 文檔化減少重複錯誤
   - 知識傳承避免重蹈覆轍

2. **測試也需要測試**
   - 測試本身也可能出錯
   - 需要驗證測試方法正確性
   - 本地測試比遠程測試安全

3. **快速響應和透明**
   - 發現問題立即確認
   - 誠實解釋和道歉
   - 建立信任最重要

---

## 🎓 關鍵要點

### 給團隊的建議

1. **永遠假設會出錯**
   - 即使是測試也要謹慎
   - 準備回滾和應急計劃
   - 多一層檢查不嫌多

2. **建立良好習慣**
   - 使用檢查清單
   - 遵循測試流程
   - 文檔化所有變更

3. **從錯誤中學習**
   - 記錄每次事件
   - 分析根本原因
   - 改進流程和工具

### 記住這個口訣

```
測試三問：
1. 會發送到哪裡？ 🎯
2. 有測試標記嗎？ 🏷️
3. 團隊知道嗎？ 📣

三問都確認才執行！
```

---

## 📎 附件

### 相關文檔
- `TESTING_BEST_PRACTICES.md` - 完整測試指南
- `TESTING_QUICK_REFERENCE.md` - 快速參考
- `lambda_function_optimized.py` - 優化後的代碼
- `lambda-test-events.json` - 測試事件模板

### 驗證命令
```bash
# 檢查實際連線數
aws cloudwatch get-metric-statistics \
  --profile gemini-pro_ck \
  --namespace AWS/RDS \
  --metric-name DatabaseConnections \
  --dimensions Name=DBInstanceIdentifier,Value=bingo-prd \
  --start-time $(date -u -d '1 hour ago' +%Y-%m-%dT%H:%M:%S) \
  --end-time $(date -u +%Y-%m-%dT%H:%M:%S) \
  --period 300 \
  --statistics Average,Maximum

# 檢查告警狀態
aws cloudwatch describe-alarms \
  --profile gemini-pro_ck \
  --query 'MetricAlarms[?AlarmName==`[P1] bingo-prd-RDS-Connections-High`].[AlarmName,StateValue]'
```

---

## 📊 事件統計

| 指標 | 值 |
|------|---|
| 發現到解決時間 | 2 分鐘 |
| 受影響用戶數 | 1 |
| 業務影響時長 | 0 分鐘 |
| 服務可用性 | 100% |
| 數據完整性 | 100% |
| 事後文檔頁數 | 3 份文檔 |

---

## ✍️ 簽核

| 角色 | 姓名 | 日期 | 簽名 |
|------|------|------|------|
| 事件處理人 | Claude Code | 2025-10-29 | ✅ |
| 審核人 | - | - | - |
| 批准人 | - | - | - |

---

**文檔版本**: 1.0
**最後更新**: 2025-10-29 17:45:00 (UTC+8)
**下次審查**: 2025-11-29 (1個月後)
**狀態**: ✅ 已關閉
