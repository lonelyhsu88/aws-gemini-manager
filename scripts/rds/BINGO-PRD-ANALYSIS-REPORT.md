# bingo-prd RDS 資料庫連接數深度分析報告

**分析日期**: 2025-10-29
**分析期間**: 2025-10-22 至 2025-10-29 (7天)
**資料庫實例**: bingo-prd
**實例規格**: db.m6g.large
**Region**: ap-east-1

---

## 執行摘要

### 關鍵發現
1. **當前連接數使用率極低**: 平均 148 連接，峰值 182 連接，僅使用 20% 的最大容量 (901)
2. **當前告警閾值過高**: 675 連接 (75%) 遠高於實際使用量，形同虛設
3. **使用模式穩定**: 7天內連接數非常穩定，標準差僅 7.47
4. **夜間流量最高**: 晚上 10點至凌晨 1點是高峰時段
5. **工作日與週末無明顯差異**: 差異僅 0.2%

### 即時建議
- **立即調整告警閾值**: 從 675 降至 **180-200** 才有實際監控意義
- **容量過剩**: 當前實例規格遠超實際需求，可考慮降級以節省成本

---

## 詳細統計分析

### 七天整體指標

| 指標 | 數值 | 說明 |
|------|------|------|
| 總數據點 | 1,008 | 每10分鐘一個數據點 |
| 平均連接數 | 148.14 | 穩定在 150 左右 |
| 中位數連接數 | 148.75 | 與平均值接近，分布對稱 |
| 最小連接數 | 123.00 | 最低使用量 |
| 最大連接數 | 182.00 | 峰值連接數 |
| 標準差 | 7.47 | 變異性極低，非常穩定 |

### 百分位數分析

| 百分位 | 連接數 | 佔最大容量比例 | 說明 |
|--------|--------|----------------|------|
| P50 (中位數) | 148.75 | 16.5% | 一半時間低於此值 |
| P75 | 153.47 | 17.0% | 75% 時間低於此值 |
| P90 | 156.80 | 17.4% | 90% 時間低於此值 |
| P95 | 158.65 | 17.6% | 95% 時間低於此值 |
| P99 | 167.70 | 18.6% | 99% 時間低於此值 |

**解讀**:
- 即使在 P99 (99% 的時間)，連接數也只有 167.7
- 當前告警閾值 675 是 P99 的 **4 倍**，完全無法發揮告警作用

---

## 每日使用趨勢

### 日期明細

| 日期 | 星期 | 平均 | 峰值 | 最低 | 峰值時間 |
|------|------|------|------|------|----------|
| 2025-10-22 | Wed | 154.41 | 182.00 | 150.20 | 22:22 |
| 2025-10-23 | Thu | 146.06 | 175.00 | 130.50 | 21:32 |
| 2025-10-24 | Fri | 146.99 | 173.00 | 129.60 | 00:32 |
| 2025-10-25 | Sat | 151.06 | 165.00 | 142.60 | 13:12 |
| 2025-10-26 | Sun | 145.55 | 172.00 | 133.90 | 23:52 |
| 2025-10-27 | Mon | 154.15 | 169.00 | 145.10 | 16:52 |
| 2025-10-28 | Tue | 147.17 | 176.00 | 129.90 | 02:12 |
| 2025-10-29 | Wed | 142.72 | 172.00 | 131.60 | 02:02 |

### 每日峰值分析
- **最高峰值**: 2025-10-22 週三 22:22，達 182 連接
- **峰值範圍**: 165-182 連接之間
- **峰值時間**: 主要集中在晚間 9點-凌晨 2點

---

## 時段使用模式

### 每小時平均連接數 (Top 10 高峰時段)

| 排名 | 時段 | 平均連接數 | 峰值連接數 | 相對基線增幅 |
|------|------|-----------|-----------|-------------|
| 1 | 00:00-01:00 | 154.83 | 173.00 | +4.5% |
| 2 | 22:00-23:00 | 153.92 | 182.00 | +4.0% |
| 3 | 23:00-00:00 | 153.79 | 175.00 | +3.9% |
| 4 | 21:00-22:00 | 152.45 | 175.00 | +2.9% |
| 5 | 01:00-02:00 | 151.43 | 167.00 | +2.2% |
| 6 | 20:00-21:00 | 151.11 | 167.00 | +2.0% |
| 7 | 15:00-16:00 | 150.10 | 165.00 | +1.3% |
| 8 | 19:00-20:00 | 149.83 | 167.00 | +1.2% |
| 9 | 02:00-03:00 | 149.82 | 176.00 | +1.1% |
| 10 | 16:00-17:00 | 149.58 | 169.00 | +1.0% |

### 每小時平均連接數 (最低 5 個時段)

| 排名 | 時段 | 平均連接數 | 峰值連接數 | 相對基線減幅 |
|------|------|-----------|-----------|-------------|
| 1 | 06:00-07:00 | 139.86 | 155.00 | -5.6% |
| 2 | 07:00-08:00 | 140.22 | 160.00 | -5.3% |
| 3 | 05:00-06:00 | 142.26 | 161.00 | -4.0% |
| 4 | 08:00-09:00 | 142.33 | 166.00 | -3.9% |
| 5 | 09:00-10:00 | 144.44 | 166.00 | -2.5% |

### 時段特徵分析

**高峰時段** (20:00-02:00):
- 平均連接數: 152.20
- 特徵: 晚間娛樂高峰，符合 Bingo 遊戲平台使用習慣
- 建議: 重點監控此時段的連接數異常

**低谷時段** (05:00-09:00):
- 平均連接數: 141.53
- 特徵: 清晨時段，用戶活躍度最低
- 建議: 可考慮在此時段進行維護作業

**差異幅度**: 高峰與低谷相差約 10.67 連接 (7.5%)，變化非常平緩

---

## 工作日 vs 週末分析

| 類型 | 平均連接數 | 峰值連接數 | 樣本天數 |
|------|-----------|-----------|----------|
| 工作日 (Mon-Fri) | 148.07 | 170.10 | 5天 |
| 週末 (Sat-Sun) | 148.31 | 159.40 | 2天 |
| 差異 | -0.24 (-0.2%) | +10.70 (+6.7%) | - |

### 觀察結論
1. **平均使用量幾乎無差異**: 工作日與週末平均連接數相差不到 1 個連接
2. **工作日峰值略高**: 工作日峰值高出週末約 10 連接，但差異不顯著
3. **全週穩定運行**: 顯示 bingo-prd 是全週 7×24 穩定運行的服務
4. **無需區分工作日/週末告警**: 可以使用統一的告警閾值

---

## 異常峰值檢測

### 檢測方法
採用統計學方法: **超過 (平均值 + 2倍標準差)** 的數據點視為異常峰值
- 異常閾值 = 148.14 + (2 × 7.47) = **163.08**

### 檢測結果
**共檢測到 25 個異常峰值** (佔總數據點的 2.5%)

#### Top 10 最高異常峰值

| 時間 | 連接數 | 偏離程度 | 說明 |
|------|--------|---------|------|
| 2025-10-23 22:02 | 169.50 | +21.36 | 週四晚間峰值 |
| 2025-10-23 21:32 | 168.80 | +20.66 | 週四晚間持續高峰 |
| 2025-10-23 21:22 | 168.30 | +20.16 | 週四晚間高峰開始 |
| 2025-10-23 22:32 | 168.00 | +19.86 | 週四晚間峰值 |
| 2025-10-23 22:42 | 167.90 | +19.76 | 週四晚間峰值 |
| 2025-10-23 21:42 | 166.50 | +18.36 | 週四晚間高峰 |
| 2025-10-23 21:52 | 165.50 | +17.36 | 週四晚間高峰 |
| 2025-10-23 22:12 | 165.70 | +17.56 | 週四晚間峰值 |
| 2025-10-23 21:12 | 164.50 | +16.36 | 週四晚間高峰前兆 |
| 2025-10-23 22:22 | 164.30 | +16.16 | 週四晚間峰值 |

### 異常模式分析

1. **集中在特定日期**: 25個異常點中，大部分集中在 2025-10-22 和 2025-10-23
2. **時段集中**: 主要發生在晚間 21:00-23:00 時段
3. **連續發生**: 異常峰值往往連續出現數個10分鐘週期
4. **幅度溫和**: 最高峰值 169.5 仍遠低於最大容量的 20%

### 異常原因推測
- 可能原因 1: 週四晚間特定活動或促銷
- 可能原因 2: 定期的流量波動屬正常範圍
- 可能原因 3: 資料取樣誤差

**重要**: 這些"異常"僅是統計學上的異常，實際上 169 連接仍在系統輕鬆負荷範圍內

---

## 趨勢與預測分析

### 七天趨勢
- **前兩天平均** (10/22-10/23): 150.24 連接
- **後兩天平均** (10/28-10/29): 144.95 連接
- **趨勢變化**: -3.5%

### 結論
- **使用量穩定**: 7天內無明顯上升或下降趨勢
- **變化幅度小**: -3.5% 的下降可能是正常波動
- **短期預測**: 預計未來 1-2 週將維持在 140-160 連接的穩定區間

### 長期容量規劃
基於當前數據:
- **當前使用率**: 20% (182/901)
- **安全餘裕**: 80%
- **是否需要擴容**: **否**，容量極度充足
- **是否可以降級**: **是**，可考慮降級至 db.t3.medium 或 db.t3.large

---

## 當前告警配置評估

### 現況
- **當前閾值**: 675 連接
- **閾值百分比**: 75% of max_connections
- **實際百分位**: P100 (高於所有觀測值)

### 問題分析

#### 問題 1: 告警閾值形同虛設
- 當前 675 連接是實際峰值 182 的 **3.7 倍**
- 要觸發此告警，連接數需要暴增 **270%**
- 在正常情況下，此告警永遠不會被觸發

#### 問題 2: 無法及早發現異常
- 如果連接數異常增加 50% (從 150 到 225)，仍遠低於告警閾值
- 無法在問題惡化前及早發現並處理

#### 問題 3: 不符合監控最佳實踐
- 業界建議: 告警閾值應設在 P95-P99 之間，提供早期預警
- 當前設置: P100，完全喪失預警功能

### 建議調整方向

**應該從"容量告警"轉變為"異常偵測告警"**

當前思維:
```
告警 = 接近最大容量 (75% = 675)
```

建議思維:
```
告警 = 顯著高於正常使用量 (基於實際數據)
```

---

## 告警閾值建議方案

### 推薦配置: 多層級告警架構

基於七天實際數據分析，建議採用 **四層級告警系統**:

#### 🟢 P3 (Low/Warning) - 預警通知
- **建議閾值**: **165 連接**
- **計算依據**: P95 (158.65) × 1.04 ≈ 165
- **觸發頻率**: 約 5% 時間 (每天 1-2次)
- **對應百分比**: 18.3% of max_connections
- **告警動作**:
  - 記錄日誌
  - 發送 Info 級別通知
  - 無需立即處理

#### 🟡 P2 (Medium) - 需要關注
- **建議閾值**: **180 連接**
- **計算依據**: P99 (167.70) × 1.07 ≈ 180
- **觸發頻率**: 約 1-2% 時間 (偶爾)
- **對應百分比**: 20.0% of max_connections
- **告警動作**:
  - 發送 Warning 級別告警
  - 通知相關人員
  - 需在 1 小時內檢查

#### 🟠 P1 (High) - 需要立即調查
- **建議閾值**: **200 連接**
- **計算依據**: 歷史最大值 (182) × 1.10 ≈ 200
- **觸發頻率**: 非常罕見 (< 0.5%)
- **對應百分比**: 22.2% of max_connections
- **告警動作**:
  - 發送 Error 級別告警
  - 立即通知 On-call 人員
  - 需在 30 分鐘內回應
  - 檢查應用程式是否有連接洩漏

#### 🔴 P0 (Critical) - 緊急狀況
- **建議閾值**: **250 連接**
- **計算依據**: 歷史最大值 (182) × 1.37 ≈ 250
- **觸發頻率**: 極度罕見 (應該永不發生)
- **對應百分比**: 27.7% of max_connections
- **告警動作**:
  - 發送 Critical 級別告警
  - 觸發 PagerDuty/緊急響應
  - 立即進行根本原因分析
  - 考慮是否需要緊急擴容或重啟應用

### 閾值設定理由

| 層級 | 閾值 | 超出正常值倍數 | 設定原則 |
|------|-----|---------------|----------|
| P3 | 165 | 1.11× | 略高於 P95，適合日常波動監控 |
| P2 | 180 | 1.21× | 略高於歷史最大值，偵測明顯異常 |
| P1 | 200 | 1.35× | 顯著異常，需要人工介入 |
| P0 | 250 | 1.69× | 嚴重異常，可能存在系統問題 |

### 與當前設置的對比

| 項目 | 當前設置 | 建議設置 (P1) | 差異 |
|------|---------|--------------|------|
| 閾值 | 675 連接 | 200 連接 | -70.4% |
| 佔最大容量 | 75% | 22% | -53% |
| 實際意義 | 幾乎不會觸發 | 能有效偵測異常 | 實用性大增 |

---

## CloudWatch Alarm 配置建議

### 推薦配置: P2 (Medium) 主要告警

```bash
aws --profile gemini-pro_ck cloudwatch put-metric-alarm \
  --alarm-name "bingo-prd-db-connections-high" \
  --alarm-description "RDS連接數超過正常水平 (P2告警)" \
  --metric-name DatabaseConnections \
  --namespace AWS/RDS \
  --statistic Average \
  --period 300 \
  --evaluation-periods 2 \
  --threshold 180 \
  --comparison-operator GreaterThanThreshold \
  --dimensions Name=DBInstanceIdentifier,Value=bingo-prd \
  --treat-missing-data notBreaching \
  --alarm-actions <SNS-TOPIC-ARN> \
  --region ap-east-1
```

### 配置: P1 (High) 高優先級告警

```bash
aws --profile gemini-pro_ck cloudwatch put-metric-alarm \
  --alarm-name "bingo-prd-db-connections-critical" \
  --alarm-description "RDS連接數異常偏高 (P1告警)" \
  --metric-name DatabaseConnections \
  --namespace AWS/RDS \
  --statistic Average \
  --period 300 \
  --evaluation-periods 3 \
  --threshold 200 \
  --comparison-operator GreaterThanThreshold \
  --dimensions Name=DBInstanceIdentifier,Value=bingo-prd \
  --treat-missing-data notBreaching \
  --alarm-actions <SNS-TOPIC-ARN> \
  --region ap-east-1
```

### 配置: P0 (Critical) 緊急告警

```bash
aws --profile gemini-pro_ck cloudwatch put-metric-alarm \
  --alarm-name "bingo-prd-db-connections-emergency" \
  --alarm-description "RDS連接數達到危險水平 (P0告警)" \
  --metric-name DatabaseConnections \
  --namespace AWS/RDS \
  --statistic Maximum \
  --period 60 \
  --evaluation-periods 2 \
  --threshold 250 \
  --comparison-operator GreaterThanThreshold \
  --dimensions Name=DBInstanceIdentifier,Value=bingo-prd \
  --treat-missing-data notBreaching \
  --alarm-actions <CRITICAL-SNS-TOPIC-ARN> \
  --region ap-east-1
```

### 參數說明

| 參數 | P2 | P1 | P0 | 說明 |
|------|----|----|----| -----|
| period | 300秒 | 300秒 | 60秒 | 評估週期 |
| evaluation-periods | 2 | 3 | 2 | 連續觸發次數 |
| statistic | Average | Average | Maximum | 統計方式 |
| 總時間窗口 | 10分鐘 | 15分鐘 | 2分鐘 | 確認時間 |

**設計思想**:
- P2: 10分鐘內連續 2 次超過 180，確認是持續性問題
- P1: 15分鐘內連續 3 次超過 200，更嚴格的確認機制
- P0: 2分鐘內連續 2 次超過 250，快速響應緊急情況

---

## 容量規劃與成本優化建議

### 當前容量分析

**實例規格**: db.m6g.large
- vCPU: 2
- Memory: 8 GB
- max_connections: 901

**實際使用情況**:
- 平均連接數: 148 (16.4% 利用率)
- 峰值連接數: 182 (20.2% 利用率)
- 餘裕空間: 719 連接 (79.8%)

### 成本優化機會

#### 選項 1: 降級至 db.t3.large (推薦)
- vCPU: 2
- Memory: 8 GB
- max_connections: ~900
- **預估節省**: 約 30-40%
- **風險**: 低 (仍有充足容量)
- **適用**: 流量穩定、無明顯增長趨勢

#### 選項 2: 降級至 db.t3.medium (謹慎評估)
- vCPU: 2
- Memory: 4 GB
- max_connections: ~450
- **預估節省**: 約 50-60%
- **風險**: 中 (峰值使用率將達 40%)
- **適用**: 需配合應用優化

#### 選項 3: 維持 db.m6g.large (保守)
- **優點**: 零風險，充足餘裕
- **缺點**: 成本較高
- **適用**: 預期短期內流量會增長

### 推薦方案

**階段 1: 立即執行 (無風險)**
1. ✅ 調整告警閾值至建議值
2. ✅ 建立連接數趨勢監控儀表板
3. ✅ 檢查應用程式連接池配置

**階段 2: 1個月後評估 (需觀察)**
1. 📊 持續監控連接數趨勢
2. 📊 評估是否有季節性變化
3. 📊 分析連接數增長率

**階段 3: 成本優化 (依數據決定)**
- 如果連接數持續穩定在 150-200 範圍，考慮降級至 db.t3.large
- 如果有增長趨勢，維持現狀並持續監控

---

## 應用層面優化建議

### 連接池檢查清單

#### 1. 檢查應用程式連接池配置
```javascript
// 範例: Node.js (pg/Sequelize)
const pool = new Pool({
  max: 20,              // 單個應用實例的最大連接數
  min: 5,               // 最小連接數
  idle: 10000,          // 閒置連接保留時間 (10秒)
  connectionTimeoutMillis: 2000,
});
```

**建議值**:
- max: 10-20 (視應用實例數量調整)
- idle: 5000-10000 ms
- 總連接數 = 單實例連接數 × 應用實例數量

#### 2. 檢查是否有連接洩漏
```bash
# 監控長時間保持的連接
SELECT pid, usename, application_name, state, state_change
FROM pg_stat_activity
WHERE state != 'idle'
AND state_change < NOW() - INTERVAL '5 minutes'
ORDER BY state_change;
```

#### 3. 檢查閒置連接
```bash
# 找出長時間 idle 的連接
SELECT pid, usename, application_name, state, state_change,
       NOW() - state_change AS idle_time
FROM pg_stat_activity
WHERE state = 'idle'
ORDER BY state_change;
```

#### 4. 應用程式檢查項目
- [ ] 確認所有數據庫查詢都有正確關閉連接
- [ ] 檢查是否有 long-running queries 佔用連接
- [ ] 確認連接池配置合理 (不過大也不過小)
- [ ] 確保錯誤處理邏輯會釋放連接
- [ ] 檢查是否有死鎖或阻塞查詢

---

## 監控儀表板建議

### CloudWatch Dashboard 配置

建議建立專屬儀表板，包含以下指標:

#### 核心指標
1. **DatabaseConnections** (主要指標)
   - 時間範圍: 7 天
   - 顯示: 平均、最大、P95 線
   - 告警線: 180 (P2), 200 (P1), 250 (P0)

2. **CPUUtilization**
   - 相關性: 連接數增加可能伴隨 CPU 上升
   - 閾值: 70%, 85%, 95%

3. **FreeableMemory**
   - 監控記憶體是否充足
   - 告警: 低於 1GB

4. **ReadLatency / WriteLatency**
   - 連接數過高可能影響延遲
   - 告警: 超過 10ms

5. **DatabaseConnections vs Time of Day**
   - 熱圖: 識別每日高峰時段
   - 用於容量規劃

### Grafana Dashboard (選配)

如果使用 Grafana，可以建立更豐富的視覺化:
```sql
-- PromQL 範例 (如果使用 Prometheus)
rate(rds_database_connections[5m])
```

---

## 行動計劃與時間表

### 第一週: 立即執行 (高優先級)

#### Day 1-2: 告警配置調整
- [ ] 備份當前告警配置
- [ ] 建立 P2 告警 (180 連接)
- [ ] 建立 P1 告警 (200 連接)
- [ ] 建立 P0 告警 (250 連接)
- [ ] 測試告警通知機制
- [ ] 更新告警文件與 Runbook

#### Day 3-5: 應用程式檢查
- [ ] 檢查各應用程式的連接池配置
- [ ] 檢查是否有連接洩漏
- [ ] 執行長時間連接查詢
- [ ] 優化不合理的連接使用

#### Day 6-7: 監控儀表板
- [ ] 建立 CloudWatch Dashboard
- [ ] 設定每日連接數報告
- [ ] 建立趨勢分析報表

### 第二-四週: 持續監控

- [ ] 每週檢視連接數趨勢
- [ ] 記錄任何告警觸發情況
- [ ] 調整閾值 (如果需要)
- [ ] 評估季節性變化

### 第二個月: 成本優化評估

- [ ] 回顧 4 週連接數數據
- [ ] 評估是否可以降級實例
- [ ] 計算潛在成本節省
- [ ] 制定降級測試計劃 (如果適用)

---

## 附錄: 技術細節

### A. CloudWatch 查詢命令

#### 獲取最近 24 小時連接數
```bash
aws --profile gemini-pro_ck cloudwatch get-metric-statistics \
  --namespace AWS/RDS \
  --metric-name DatabaseConnections \
  --dimensions Name=DBInstanceIdentifier,Value=bingo-prd \
  --start-time $(date -u -v-24H +%Y-%m-%dT%H:%M:%S) \
  --end-time $(date -u +%Y-%m-%dT%H:%M:%S) \
  --period 3600 \
  --statistics Average,Maximum,Minimum \
  --region ap-east-1 \
  --output table
```

#### 查看當前告警配置
```bash
aws --profile gemini-pro_ck cloudwatch describe-alarms \
  --alarm-name-prefix "bingo-prd" \
  --region ap-east-1 \
  --output table
```

### B. 資料庫查詢命令

#### 查看當前連接數
```sql
SELECT COUNT(*) AS current_connections
FROM pg_stat_activity;
```

#### 查看各應用的連接數
```sql
SELECT application_name,
       COUNT(*) AS connection_count,
       state
FROM pg_stat_activity
WHERE application_name IS NOT NULL
GROUP BY application_name, state
ORDER BY connection_count DESC;
```

#### 查看連接詳情
```sql
SELECT pid, usename, application_name, client_addr,
       state, query_start, state_change, query
FROM pg_stat_activity
WHERE state != 'idle'
ORDER BY query_start;
```

### C. Python 分析腳本

完整的分析腳本已保存在:
```
/Users/lonelyhsu/gemini/claude-project/aws-gemini-manager/scripts/rds/analyze-bingo-prd-connections.py
```

使用方法:
```bash
python3 scripts/rds/analyze-bingo-prd-connections.py
```

輸出:
- 終端顯示完整分析報告
- JSON 檔案保存詳細數據 (`bingo-prd-analysis-*.json`)

---

## 結論

### 關鍵要點

1. **當前告警設定不適當**
   - 675 連接的閾值遠高於實際使用量
   - 建議調整至 **180-200** 連接範圍

2. **容量大幅過剩**
   - 實際使用率僅 20%
   - 有成本優化空間，可考慮降級實例

3. **系統運行穩定**
   - 連接數變化平穩，無異常波動
   - 工作日與週末無顯著差異
   - 高峰時段集中在晚間 10點至凌晨 1點

4. **無近期擴容需求**
   - 連接數趨勢穩定
   - 短期內無需擴容

### 立即行動項目

**優先級 1 (本週完成)**:
1. ✅ 調整告警閾值至 180 (P2) 和 200 (P1)
2. ✅ 建立連接數監控儀表板
3. ✅ 檢查應用程式連接池配置

**優先級 2 (一個月內)**:
1. 📊 持續監控連接數趨勢
2. 📊 評估成本優化機會
3. 📊 建立定期檢視機制

### 聯繫方式

如有任何問題或需要進一步分析，請聯繫 DevOps 團隊。

---

**報告產生時間**: 2025-10-29 17:22:07
**下次審查時間**: 2025-11-29 (建議每月審查一次)
**分析工具版本**: analyze-bingo-prd-connections.py v1.0
